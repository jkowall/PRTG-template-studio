<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTG Template Studio</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            850: '#1f2025', # Custom midway shade
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            background-color: #09090b;
            /* zinc-950 */
            color: #f4f4f5;
            /* zinc-100 */
        }

        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #18181b;
            /* zinc-900 */
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            /* zinc-700 */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
            /* zinc-600 */
        }
    </style>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="h-screen overflow-hidden flex flex-col font-sans text-sm">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Utils ---
        const parseXML = (xmlStr) => {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlStr, "application/xml");
                if (doc.querySelector("parsererror")) {
                    return { error: "XML Parse Error" };
                }
                return doc;
            } catch (e) {
                return { error: e.message };
            }
        };

        // --- Visual Preview Component ---
        const XmlNode = ({ node }) => {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                return text ? <div class="text-zinc-600 dark:text-zinc-400 break-words">{text}</div> : null;
            }

            if (node.nodeType === Node.ELEMENT_NODE) {
                const tagName = node.tagName;
                const children = Array.from(node.childNodes);
                const hasChildren = children.some(c => c.nodeType === Node.ELEMENT_NODE || (c.nodeType === Node.TEXT_NODE && c.textContent.trim()));

                // Style based on tag name
                let borderColor = "border-zinc-700";
                let titleColor = "text-zinc-300";

                if (tagName.toLowerCase() === 'create') {
                    borderColor = "border-green-800/50";
                    titleColor = "text-green-400";
                } else if (tagName.toLowerCase() === 'check') {
                    borderColor = "border-blue-800/50";
                    titleColor = "text-blue-400";
                }

                return (
                    <div class={`ml-4 my-1 pl-2 border-l-2 ${borderColor}`}>
                        <div class={`font-mono font-semibold ${titleColor} text-xs uppercase mb-1`}>
                            {tagName}
                            {Array.from(node.attributes).map(attr => (
                                <span key={attr.name} class="ml-2 font-normal text-zinc-500 lowercase">
                                    {attr.name}="<span class="text-amber-600 dark:text-amber-200/80">{attr.value}</span>"
                                </span>
                            ))}
                        </div>
                        {hasChildren && (
                            <div class="ml-1">
                                {children.map((child, i) => <XmlNode key={i} node={child} />)}
                            </div>
                        )}
                    </div>
                );
            }
            return null;
        };

        const Preview = ({ xmlString }) => {
            const xmlDoc = useMemo(() => parseXML(xmlString), [xmlString]);

            if (!xmlString) return <div class="p-8 text-zinc-500 dark:text-zinc-600 italic text-center">Select a template to view details</div>;
            if (xmlDoc.error) return <div class="p-4 text-red-600 dark:text-red-500 bg-red-100 dark:bg-red-950/20 border border-red-300 dark:border-red-900 rounded m-4">{xmlDoc.error}</div>;

            return (
                <div class="p-4 overflow-auto h-full">
                    <XmlNode node={xmlDoc.documentElement} />
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [templates, setTemplates] = useState([]);
            const [selectedFile, setSelectedFile] = useState(null);
            const [activeType, setActiveType] = useState('device'); // device, snmp, lookup
            const [content, setContent] = useState("");
            const [initialContent, setInitialContent] = useState("");
            const [status, setStatus] = useState("");
            const [loading, setLoading] = useState(false);
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark');

            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            useEffect(() => {
                fetchTemplates();
                setSelectedFile(null);
                setContent("");
                setInitialContent("");
            }, [activeType]);

            const fetchTemplates = async () => {
                try {
                    const res = await fetch(`/api/templates?type=${activeType}`);
                    if (res.ok) {
                        const data = await res.json();
                        setTemplates(data);
                    }
                } catch (e) {
                    console.error("Failed to fetch templates", e);
                }
            };

            const loadTemplate = async (filename) => {
                if (content !== initialContent && !confirm("Unsaved changes! Discard?")) return;

                setLoading(true);
                try {
                    const res = await fetch(`/api/template/${filename}?type=${activeType}`);
                    if (res.ok) {
                        const data = await res.json();
                        setSelectedFile(filename);
                        setContent(data.content);
                        setInitialContent(data.content);
                        setStatus(`Loaded ${filename}`);
                    }
                } catch (e) {
                    setStatus("Error loading file");
                } finally {
                    setLoading(false);
                }
            };

            const saveTemplate = async () => {
                if (!selectedFile) return;
                setStatus("Saving...");
                try {
                    const res = await fetch(`/api/template/${selectedFile}?type=${activeType}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setStatus(data.message || "Saved.");
                        setInitialContent(content);
                    } else {
                        setStatus(`Error: ${data.error || "Unknown error"}`);
                    }
                } catch (e) {
                    setStatus(`Error: ${e.message}`);
                }
            };

            const isDirty = content !== initialContent;

            return (
                <div class="flex h-screen w-full bg-zinc-950 text-zinc-200">

                    {/* Sidebar */}
                    <div class="w-64 flex-shrink-0 border-r border-zinc-800 bg-zinc-900 flex flex-col">
                        <div class="p-4 border-b border-zinc-800">
                            <h1 class="font-bold text-zinc-100 tracking-tight mb-3">PRTG Studio</h1>
                            <div class="flex bg-zinc-950 rounded p-1 gap-1">
                                {['device', 'snmp', 'lookup'].map(type => (
                                    <button
                                        key={type}
                                        onClick={() => setActiveType(type)}
                                        class={`flex-1 py-1 px-2 text-[10px] uppercase font-bold rounded transition-colors ${activeType === type
                                            ? 'bg-zinc-800 text-zinc-100 shadow-sm'
                                            : 'text-zinc-500 hover:text-zinc-300'
                                            }`}
                                    >
                                        {type}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1">
                            {templates.length === 0 && <div class="text-xs text-zinc-600 p-2 text-center italic">No {activeType} files found</div>}
                            {templates.map(file => (
                                <button
                                    key={file}
                                    onClick={() => loadTemplate(file)}
                                    class={`w-full text-left px-3 py-2 rounded text-xs font-medium transition-colors ${selectedFile === file
                                        ? 'bg-blue-600/10 text-blue-400 border border-blue-600/20'
                                        : 'hover:bg-zinc-800 text-zinc-400'
                                        }`}
                                >
                                    {file}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div class="flex-1 flex flex-col min-w-0">
                        {/* Toolbar */}
                        <div class="h-14 border-b border-zinc-800 bg-zinc-900/50 flex items-center justify-between px-6 backdrop-blur">
                            <div class="font-mono text-sm text-zinc-400">
                                {selectedFile || "No file selected"}
                                {isDirty && <span class="text-amber-500 ml-2">*</span>}
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs text-zinc-500">{status}</span>
                                <button
                                    onClick={saveTemplate}
                                    disabled={!isDirty || loading}
                                    class={`px-4 py-1.5 rounded text-xs font-semibold transition-all ${isDirty
                                        ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20'
                                        : 'bg-zinc-800 text-zinc-500 cursor-not-allowed'
                                        }`}
                                >
                                    {loading ? 'Saving...' : 'Save Changes'}
                                </button>
                            </div>
                        </div>

                        {/* Editor Split */}
                        <div class="flex-1 flex overflow-hidden">
                            {/* Editor */}
                            <div class="w-1/2 flex flex-col border-r border-zinc-800">
                                <div class="bg-zinc-950 px-4 py-2 text-xs font-semibold text-zinc-500 uppercase tracking-wider border-b border-zinc-800">XML Source</div>
                                <textarea
                                    class="flex-1 w-full h-full bg-zinc-950 p-4 font-mono text-sm leading-relaxed text-zinc-300 focus:outline-none resize-none"
                                    spellCheck="false"
                                    value={content}
                                    onChange={e => setContent(e.target.value)}
                                    placeholder="Select a template..."
                                />
                            </div>

                            {/* Preview */}
                            <div class="w-1/2 flex flex-col bg-zinc-925/30">
                                <div class="bg-zinc-950 px-4 py-2 text-xs font-semibold text-zinc-500 uppercase tracking-wider border-b border-zinc-800">Visual Structure</div>
                                <div class="flex-1 overflow-auto bg-zinc-900/30">
                                    <Preview xmlString={content} />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>