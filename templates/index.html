<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTG Template Studio</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            850: '#1f2025',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    }
                }
            }
        }

        // Immediately apply theme to prevent FOUC
        try {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Default to dark if no save, or if saved is dark
            if (savedTheme === 'dark' || (!savedTheme)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        } catch (e) {
            console.error("Error applying theme:", e);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap');

        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            @apply bg-zinc-100 dark:bg-zinc-900;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-zinc-300 dark:bg-zinc-700;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            @apply bg-zinc-400 dark:bg-zinc-600;
        }
    </style>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body
    class="h-screen overflow-hidden flex flex-col font-sans text-sm bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 transition-colors duration-200">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Utils ---
        const parseXML = (xmlStr) => {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlStr, "application/xml");
                if (doc.querySelector("parsererror")) {
                    return { error: "XML Parse Error" };
                }
                return doc;
            } catch (e) {
                return { error: e.message };
            }
        };

        // --- Visual Preview Component ---
        const XmlNode = ({ node }) => {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                return text ? <div class="text-zinc-600 dark:text-zinc-300 break-words">{text}</div> : null;
            }

            if (node.nodeType === Node.ELEMENT_NODE) {
                const tagName = node.tagName;
                const children = Array.from(node.childNodes);
                const hasChildren = children.some(c => c.nodeType === Node.ELEMENT_NODE || (c.nodeType === Node.TEXT_NODE && c.textContent.trim()));

                // Style based on tag name
                let borderColor = "border-zinc-300 dark:border-zinc-700/60";
                let titleColor = "text-zinc-700 dark:text-zinc-300";
                let containerBg = "";

                if (tagName.toLowerCase() === 'create') {
                    borderColor = "border-green-600/30 dark:border-green-500/30";
                    titleColor = "text-green-700 dark:text-green-300";
                    containerBg = "bg-green-50/50 dark:bg-green-900/10";
                } else if (tagName.toLowerCase() === 'check') {
                    borderColor = "border-blue-600/30 dark:border-blue-500/30";
                    titleColor = "text-blue-700 dark:text-blue-300";
                    containerBg = "bg-blue-50/50 dark:bg-blue-900/10";
                }

                return (
                    <div class={`ml-4 my-1 pl-2 border-l-2 ${borderColor} ${containerBg} rounded-r-sm`}>
                        <div class={`font-mono font-semibold ${titleColor} text-xs uppercase mb-1 pt-0.5`}>
                            {tagName}
                            {Array.from(node.attributes).map(attr => (
                                <span key={attr.name} class="ml-2 font-normal text-zinc-500 dark:text-zinc-500 lowercase">
                                    {attr.name}=<span class="text-amber-700 dark:text-amber-300">"{attr.value}"</span>
                                </span>
                            ))}
                        </div>
                        {hasChildren && (
                            <div class="ml-1 border-l border-zinc-200 dark:border-zinc-800 pl-1">
                                {children.map((child, i) => <XmlNode key={i} node={child} />)}
                            </div>
                        )}
                    </div>
                );
            }
            return null;
        };

        const Preview = ({ xmlString }) => {
            const xmlDoc = useMemo(() => parseXML(xmlString), [xmlString]);

            if (!xmlString) return <div class="p-8 text-zinc-500 dark:text-zinc-600 italic text-center">Select a template to view details</div>;
            if (xmlDoc.error) return <div class="p-4 text-red-600 dark:text-red-500 bg-red-100 dark:bg-red-950/20 border border-red-300 dark:border-red-900 rounded m-4">{xmlDoc.error}</div>;

            return (
                <div class="p-4 overflow-auto h-full">
                    <XmlNode node={xmlDoc.documentElement} />
                </div>
            );
        };

            );
        };

        const HistoryModal = ({ isOpen, onClose, history, filename }) => {
            if (!isOpen) return null;

            return (
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div class="bg-white dark:bg-zinc-900 rounded-lg shadow-xl w-full max-w-2xl border border-zinc-200 dark:border-zinc-800 flex flex-col max-h-[80vh]">
                        <div class="flex items-center justify-between p-4 border-b border-zinc-200 dark:border-zinc-800">
                            <h3 class="font-bold text-lg text-zinc-900 dark:text-zinc-100">History: {filename}</h3>
                            <button onClick={onClose} class="text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300">
                                âœ•
                            </button>
                        </div>
                        <div class="overflow-y-auto p-0 flex-1">
                            {history.length === 0 ? (
                                <div class="p-8 text-center text-zinc-500 italic">No history found for this file.</div>
                            ) : (
                                <table class="w-full text-left text-xs">
                                    <thead class="bg-zinc-50 dark:bg-zinc-950/50 text-zinc-500 font-semibold uppercase sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 border-b border-zinc-100 dark:border-zinc-800">Date</th>
                                            <th class="px-4 py-2 border-b border-zinc-100 dark:border-zinc-800">Author</th>
                                            <th class="px-4 py-2 border-b border-zinc-100 dark:border-zinc-800">Message</th>
                                            <th class="px-4 py-2 border-b border-zinc-100 dark:border-zinc-800">Commit</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-zinc-100 dark:divide-zinc-800">
                                        {history.map((commit) => (
                                            <tr key={commit.hash} class="hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-colors">
                                                <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400 whitespace-nowrap">
                                                    {new Date(commit.date).toLocaleString()}
                                                </td>
                                                <td class="px-4 py-3 text-zinc-800 dark:text-zinc-300 font-medium">
                                                    {commit.author}
                                                </td>
                                                <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400">
                                                    {commit.message}
                                                </td>
                                                <td class="px-4 py-3 font-mono text-zinc-400 text-[10px]">
                                                    {commit.hash.substring(0, 7)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div class="p-4 border-t border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50 rounded-b-lg flex justify-end">
                            <button onClick={onClose} class="px-4 py-2 bg-zinc-200 dark:bg-zinc-800 hover:bg-zinc-300 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-300 rounded text-xs font-semibold">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [templates, setTemplates] = useState([]);
            const [selectedFile, setSelectedFile] = useState(null);
            const [activeType, setActiveType] = useState('device'); // device, snmp, lookup
            const [content, setContent] = useState("");
            const [initialContent, setInitialContent] = useState("");
            const [status, setStatus] = useState("");
            const [loading, setLoading] = useState(false);
            const [filter, setFilter] = useState('all'); // all, default, custom
            const [history, setHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);

            // Initialize theme from localStorage or default to dark
            const [theme, setTheme] = useState(() => {
                const saved = localStorage.getItem('theme');
                return saved ? saved : 'dark';
            });

            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            useEffect(() => {
                fetchTemplates();
                setSelectedFile(null);
                setContent("");
                setInitialContent("");
            }, [activeType]);

            const fetchTemplates = async () => {
                try {
                    const res = await fetch(`/api/templates?type=${activeType}`);
                    if (res.ok) {
                        const data = await res.json();
                        setTemplates(data);
                    }
                } catch (e) {
                    console.error("Failed to fetch templates", e);
                }
            };

            const loadTemplate = async (filename) => {
                if (content !== initialContent && !confirm("Unsaved changes! Discard?")) return;

                setLoading(true);
                try {
                    const res = await fetch(`/api/template/${filename}?type=${activeType}`);
                    if (res.ok) {
                        const data = await res.json();
                        setSelectedFile(filename);
                        setContent(data.content);
                        setInitialContent(data.content);
                        setStatus(`Loaded ${filename}`);
                    }
                } catch (e) {
                    setStatus("Error loading file");
                } finally {
                    setLoading(false);
                }
            };

            const saveTemplate = async () => {
                if (!selectedFile) return;
                setStatus("Saving...");
                try {
                    const res = await fetch(`/api/template/${selectedFile}?type=${activeType}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setStatus(data.message || "Saved.");
                        setInitialContent(content);
                    } else {
                        setStatus(`Error: ${data.error || "Unknown error"}`);
                    }
                } catch (e) {
                    setStatus(`Error: ${e.message}`);
                }
            };

            const loadHistory = async () => {
                if (!selectedFile) return;
                try {
                    const res = await fetch(`/api/template/${selectedFile}/history?type=${activeType}`);
                    if (res.ok) {
                        const data = await res.json();
                        setHistory(data);
                        setShowHistory(true);
                    }
                } catch (e) {
                    console.error("Failed to load history", e);
                }
            };

            const isDirty = content !== initialContent;

            return (
                <div class="flex h-screen w-full bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-200 transition-colors duration-200">

                    {/* Sidebar */}
                    <div class="w-64 flex-shrink-0 border-r border-zinc-200 dark:border-zinc-800 bg-zinc-100 dark:bg-zinc-900 flex flex-col transition-colors duration-200">
                        <div class="p-4 border-b border-zinc-200 dark:border-zinc-800">
                            <div class="flex items-center justify-between mb-3">
                                <h1 class="font-bold text-zinc-900 dark:text-zinc-100 tracking-tight">PRTG Studio</h1>
                                <button onClick={toggleTheme} class="p-1 rounded hover:bg-zinc-200 dark:hover:bg-zinc-800 text-zinc-500 dark:text-zinc-400">
                                    {theme === 'dark' ? 'â˜€' : 'ðŸŒ™'}
                                </button>
                            </div>
                            <div class="flex bg-zinc-200 dark:bg-zinc-950 rounded p-1 gap-1">
                                {['device', 'snmp', 'lookup'].map(type => (
                                    <button
                                        key={type}
                                        onClick={() => setActiveType(type)}
                                        class={`flex-1 py-1 px-2 text-[10px] uppercase font-bold rounded transition-colors ${activeType === type
                                            ? 'bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100 shadow-sm'
                                            : 'text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'
                                            }`}
                                    >
                                        {type}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Filter Toggles */}
                        <div class="px-4 pb-2">
                            <div class="flex bg-zinc-200 dark:bg-zinc-800/50 rounded p-0.5">
                                {['all', 'default', 'custom'].map(f => (
                                    <button
                                        key={f}
                                        onClick={() => setFilter(f)}
                                        class={`flex-1 py-1 text-[9px] uppercase font-bold rounded-sm transition-all ${filter === f
                                            ? 'bg-white dark:bg-zinc-700 text-zinc-900 dark:text-zinc-100 shadow-sm'
                                            : 'text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'
                                            }`}
                                    >
                                        {f}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-2 space-y-1">
                            {templates.filter(file => {
                                const isCustom = file.includes('/') || file.includes('\\');
                                if (filter === 'default') return !isCustom;
                                if (filter === 'custom') return isCustom;
                                return true;
                            }).length === 0 && (
                                    <div class="text-xs text-zinc-500 dark:text-zinc-600 p-8 text-center italic">
                                        No {filter !== 'all' ? filter : ''} {activeType} files found
                                    </div>
                                )}

                            {templates.filter(file => {
                                const isCustom = file.includes('/') || file.includes('\\');
                                if (filter === 'default') return !isCustom;
                                if (filter === 'custom') return isCustom;
                                return true;
                            }).map(file => {
                                const isCustom = file.includes('/') || file.includes('\\');
                                return (
                                    <button
                                        key={file}
                                        onClick={() => loadTemplate(file)}
                                        class={`w-full text-left px-3 py-2 rounded text-xs font-medium transition-all group flex items-center justify-between ${selectedFile === file
                                            ? 'bg-blue-100 dark:bg-blue-500/10 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-500/20'
                                            : 'hover:bg-zinc-200 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400 border border-transparent'
                                            }`}
                                    >
                                        <span class="truncate mr-2" title={file}>{file}</span>
                                        {isCustom && (
                                            <div class="w-1.5 h-1.5 rounded-full bg-indigo-500 dark:bg-indigo-400" title="Custom Template"></div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div class="flex-1 flex flex-col min-w-0">
                        {/* Toolbar */}
                        <div class="h-14 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50/50 dark:bg-zinc-900/50 flex items-center justify-between px-6 backdrop-blur transition-colors duration-200">
                            <div class="font-mono text-sm text-zinc-500 dark:text-zinc-400">
                                {selectedFile || "No file selected"}
                                {isDirty && <span class="text-amber-500 ml-2">*</span>}
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs text-zinc-500">{status}</span>
                                <button
                                    onClick={saveTemplate}
                                    disabled={!isDirty || loading}
                                    class={`px-4 py-1.5 rounded text-xs font-semibold transition-all ${isDirty
                                        ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20'
                                        : 'bg-zinc-200 dark:bg-zinc-800 text-zinc-400 dark:text-zinc-500 cursor-not-allowed'
                                        }`}
                                >
                                    {loading ? 'Saving...' : 'Save Changes'}
                                </button>
                            </div>
                        </div>

                        {/* Editor Split */}
                        <div class="flex-1 flex overflow-hidden">
                            {/* Editor */}
                            <div class="w-1/2 flex flex-col border-r border-zinc-200 dark:border-zinc-800 transition-colors duration-200">
                                <div class="bg-zinc-100 dark:bg-zinc-950 px-4 py-2 text-xs font-semibold text-zinc-500 uppercase tracking-wider border-b border-zinc-200 dark:border-zinc-800">XML Source</div>
                                <textarea
                                    class="flex-1 w-full h-full bg-white dark:bg-zinc-950 p-4 font-mono text-sm leading-relaxed text-zinc-800 dark:text-zinc-300 focus:outline-none resize-none transition-colors duration-200"
                                    spellCheck="false"
                                    value={content}
                                    onChange={e => setContent(e.target.value)}
                                    placeholder="Select a template..."
                                />
                            </div>

                            {/* Preview */}
                            <div class="w-1/2 flex flex-col bg-zinc-50 dark:bg-[#0c0c0e] transition-colors duration-200">
                                <div class="bg-zinc-100 dark:bg-zinc-950 px-4 py-2 text-xs font-semibold text-zinc-500 uppercase tracking-wider border-b border-zinc-200 dark:border-zinc-800">Visual Structure</div>
                                <div class="flex-1 overflow-auto">
                                    <Preview xmlString={content} />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>